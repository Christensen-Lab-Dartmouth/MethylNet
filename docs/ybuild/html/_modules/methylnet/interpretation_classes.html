

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>methylnet.interpretation_classes &mdash; MethylNet 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MethylNet
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MethylNet</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>methylnet.interpretation_classes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for methylnet.interpretation_classes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">interpretation_classes.py</span>
<span class="sd">=======================</span>
<span class="sd">Contains core classes and functions to extracting explanations for the predictions at single samples, and then interrogates important CpGs for biological plausibility.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">shap</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">methylnet.datasets</span> <span class="k">import</span> <span class="n">RawBetaArrayDataSet</span><span class="p">,</span> <span class="n">Transformer</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="k">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="k">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">pymethylprocess.MethylationDataTypes</span> <span class="k">import</span> <span class="n">MethylationArray</span><span class="p">,</span> <span class="n">MethylationArrays</span><span class="p">,</span> <span class="n">extract_pheno_beta_df_from_pickle_dict</span>


<span class="sd">&quot;&quot;&quot;Normal breast 5hmC</span>
<span class="sd">chip seq enrichment</span>
<span class="sd">roadmap -&gt; hmm chromatin state learning</span>
<span class="sd">Encode</span>
<span class="sd">Blueprint</span>
<span class="sd">Geo</span>
<span class="sd">lola r packages</span>
<span class="sd">https://bioconductor.org/packages/release/bioc/html/rGREAT.html</span>
<span class="sd">https://academic.oup.com/bioinformatics/article/26/13/1662/201195</span>
<span class="sd">http://great.stanford.edu/public/html/</span>
<span class="sd">https://www.google.com/search?ei=_7wXXNPfEKyK5wLbpI2oAw&amp;q=great+enrichment+genomic+cpg+r&amp;oq=great+enrichment+genomic+cpg+r&amp;gs_l=psy-ab.3..33i299l3.529.724..899...0.0..0.84.160.2......0....1..gws-wiz.dJT2-0two-Q</span>
<span class="sd">https://www.rdocumentation.org/packages/missMethyl/versions/1.6.2/topics/gometh</span>
<span class="sd">https://bioconductor.org/packages/devel/bioc/vignettes/methylGSA/inst/doc/methylGSA-vignette.html</span>

<span class="sd">5hmc project</span>

<span class="sd">Read Lola and great papers</span>
<span class="sd">&quot;&quot;&quot;</span>



<div class="viewcode-block" id="ShapleyData"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyData">[docs]</a><span class="k">class</span> <span class="nc">ShapleyData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Store SHAP results that stores feature importances of CpGs on varying degrees granularity.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    top_cpgs : type</span>
<span class="sd">        Quick accessible CpGs that have the n highest SHAP scores.</span>
<span class="sd">    shapley_values : type</span>
<span class="sd">        Storing all SHAPley values for CpGs for varying degrees granularity. For classification problems, this only includes SHAP scores particular to the actual class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        top_cpgs:</span>
<span class="sd">            classes:</span>
<span class="sd">                invididuals:</span>
<span class="sd">                    individual:</span>
<span class="sd">                        top_cpgs</span>
<span class="sd">                overall:</span>
<span class="sd">                    top_cpgs</span>
<span class="sd">            overall:</span>
<span class="sd">                top_cpgs</span>
<span class="sd">        shapley_values:</span>
<span class="sd">            class:</span>
<span class="sd">                individual:</span>
<span class="sd">                    shapley_values</span>
<span class="sd">            overall:</span>
<span class="sd">                shapley_values</span>
<span class="sd">        methods to access data</span>
<span class="sd">        force_plot</span>
<span class="sd">        summary_plot</span>
<span class="sd">        explainer.expected_value</span>
<span class="sd">        save figures</span>
<span class="sd">        add methods for misclassified</span>
<span class="sd">        return global shapley scores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;by_class&#39;</span><span class="p">:{},</span><span class="s1">&#39;overall&#39;</span><span class="p">:{}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shapley_values</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;by_class&#39;</span><span class="p">:{},</span><span class="s1">&#39;overall&#39;</span><span class="p">:{}}</span>

<div class="viewcode-block" id="ShapleyData.add_class"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyData.add_class">[docs]</a>    <span class="k">def</span> <span class="nf">add_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">shap_df</span><span class="p">,</span> <span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_cpgs</span><span class="p">,</span> <span class="n">add_top_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store SHAP scores for particular class to Shapley_Data class. Save feature importances on granular level, explanations for individual and aggregate predictions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        class_name : type</span>
<span class="sd">            Particular class name to be stored in dictionary structure.</span>
<span class="sd">        shap_df : type</span>
<span class="sd">            SHAP data to pull from.</span>
<span class="sd">        cpgs : type</span>
<span class="sd">            All CpGs.</span>
<span class="sd">        n_top_cpgs : type</span>
<span class="sd">            Number of top CpGs for saving n top CpGs.</span>
<span class="sd">        add_top_negative : type</span>
<span class="sd">            Only consider top negative scores.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">signed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">add_top_negative</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">]</span><span class="o">=</span><span class="n">shap_df</span>
        <span class="n">shap_vals</span><span class="o">=</span><span class="n">shap_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">class_importance_shaps</span> <span class="o">=</span> <span class="n">shap_vals</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">class_importance_shaps</span><span class="o">*</span><span class="n">signed</span><span class="p">)[:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;by_individual&#39;</span><span class="p">:{},</span><span class="s1">&#39;overall&#39;</span><span class="p">:{}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">cpgs</span><span class="p">[</span><span class="n">top_idx</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">class_importance_shaps</span><span class="p">[</span><span class="n">top_idx</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]]),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">])</span>
        <span class="n">top_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">shap_vals</span><span class="o">*</span><span class="n">signed</span><span class="p">)[:,:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">individual</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">shap_df</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">shap_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">top_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ShapleyData.add_global_importance"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyData.add_global_importance">[docs]</a>    <span class="k">def</span> <span class="nf">add_global_importance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_importance_shaps</span><span class="p">,</span> <span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_cpgs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add overall feature importances, globally across all samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        global_importance_shaps : type</span>
<span class="sd">            Overall SHAP values to be saved, aggregated across all samples.</span>
<span class="sd">        cpgs : type</span>
<span class="sd">            All CpGs.</span>
<span class="sd">        n_top_cpgs : type</span>
<span class="sd">            Number of top CpGs to rank and save as well.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">global_importance_shaps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;shapley_values&#39;</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">cpgs</span><span class="p">)</span>
        <span class="n">top_ft_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">global_importance_shaps</span><span class="o">*-</span><span class="mi">1</span><span class="p">)[:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">cpgs</span><span class="p">[</span><span class="n">top_ft_idx</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">global_importance_shaps</span><span class="p">[</span><span class="n">top_ft_idx</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]]),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ShapleyData.to_pickle"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyData.to_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">output_pkl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export Shapley data to pickle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_pkl : type</span>
<span class="sd">            Output file to save SHAPley data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_pkl</span><span class="p">[:</span><span class="n">output_pkl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)],</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_pkl</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="ShapleyData.from_pickle"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyData.from_pickle">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_pkl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load SHAPley data from pickle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_pkl : type</span>
<span class="sd">            Input pickle.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">input_pkl</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="ShapleyDataExplorer"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer">[docs]</a><span class="k">class</span> <span class="nc">ShapleyDataExplorer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Datatype used to explore saved ShapleyData.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shapley_data : type</span>
<span class="sd">        ShapleyData instance to be explored.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    indiv2class : type</span>
<span class="sd">        Maps individuals to their classes used for quick look-up.</span>
<span class="sd">    shapley_data</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapley_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">=</span><span class="n">shapley_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indiv2class</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">individual</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indiv2class</span><span class="p">[</span><span class="n">individual</span><span class="p">]</span><span class="o">=</span><span class="n">class_name</span>

<div class="viewcode-block" id="ShapleyDataExplorer.return_shapley_data_by_methylation_status"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.return_shapley_data_by_methylation_status">[docs]</a>    <span class="k">def</span> <span class="nf">return_shapley_data_by_methylation_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methyl_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return dictionary containing two SHAPley datasets, each split by low/high levels of methylation. Todo: Define this using median methylation value vs 0.5.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        methyl_array : type</span>
<span class="sd">            MethylationArray instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dictionary</span>
<span class="sd">            Contains shapley data by methylation status.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">methylation_shapley_data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hyper&#39;</span><span class="p">:</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="p">),</span><span class="s1">&#39;hypo&#39;</span><span class="p">:</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">individual</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_individuals</span><span class="p">(</span><span class="n">return_list</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">class_name</span><span class="p">,</span><span class="n">individual</span><span class="p">,</span><span class="n">top_shap_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">view_methylation</span><span class="p">(</span><span class="n">individual</span><span class="p">,</span><span class="n">methyl_array</span><span class="p">)</span>
            <span class="n">hyper_df</span> <span class="o">=</span> <span class="n">top_shap_df</span><span class="p">[</span><span class="n">top_shap_df</span><span class="p">[</span><span class="s1">&#39;methylation&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">]</span>
            <span class="n">hypo_df</span> <span class="o">=</span> <span class="n">top_shap_df</span><span class="p">[</span><span class="n">top_shap_df</span><span class="p">[</span><span class="s1">&#39;methylation&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">]</span>
            <span class="n">methylation_shapley_data_dict</span><span class="p">[</span><span class="s1">&#39;hyper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span><span class="o">=</span><span class="n">hyper_df</span><span class="p">[[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">]]</span>
            <span class="n">methylation_shapley_data_dict</span><span class="p">[</span><span class="s1">&#39;hypo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span><span class="o">=</span><span class="n">hypo_df</span><span class="p">[[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">class_name</span><span class="p">,</span><span class="n">individuals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_individuals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">top_shap_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
            <span class="n">top_shap_df</span><span class="p">[</span><span class="s1">&#39;methylation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">methyl_array</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individuals</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">][</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="n">hyper_df</span> <span class="o">=</span> <span class="n">top_shap_df</span><span class="p">[</span><span class="n">top_shap_df</span><span class="p">[</span><span class="s1">&#39;methylation&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="p">]</span>
            <span class="n">hypo_df</span> <span class="o">=</span> <span class="n">top_shap_df</span><span class="p">[</span><span class="n">top_shap_df</span><span class="p">[</span><span class="s1">&#39;methylation&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">]</span>
            <span class="n">methylation_shapley_data_dict</span><span class="p">[</span><span class="s1">&#39;hyper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">hyper_df</span><span class="p">[[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">]]</span>
            <span class="n">methylation_shapley_data_dict</span><span class="p">[</span><span class="s1">&#39;hypo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">hypo_df</span><span class="p">[[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">methylation_shapley_data_dict</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.return_binned_shapley_data"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.return_binned_shapley_data">[docs]</a>    <span class="k">def</span> <span class="nf">return_binned_shapley_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_class_name</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">add_top_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts existing shap data based on continuous variable predictions into categorical variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        original_class_name : type</span>
<span class="sd">            Regression results were split into ClassName_pos and ClassName_neg, what is the ClassName?</span>
<span class="sd">        outcome_col : type</span>
<span class="sd">            Feed in from pheno sheet one the column to bin samples on.</span>
<span class="sd">        add_top_negative : type</span>
<span class="sd">            Looking to include negative SHAPs?</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ShapleyData</span>
<span class="sd">            With new class labels, built from regression results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">class_names</span> <span class="o">=</span> <span class="n">outcome_col</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">new_shapley_data</span> <span class="o">=</span> <span class="n">ShapleyData</span><span class="p">()</span>
        <span class="n">new_shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span>
        <span class="n">cpgs</span> <span class="o">=</span> <span class="n">new_shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">new_shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span>
        <span class="n">n_top_cpgs</span> <span class="o">=</span> <span class="n">new_shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">regression_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">regression_class</span> <span class="ow">in</span> <span class="n">regression_classes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">regression_class</span><span class="p">,</span><span class="n">original_class_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">regression_class</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">original_class_name</span><span class="p">):</span>
                <span class="n">shap_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">regression_class</span><span class="p">]</span><span class="c1">#[&#39;by_class&#39;][regression_class]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">shap_df</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">outcome_col</span><span class="p">[</span><span class="n">outcome_col</span><span class="o">==</span><span class="n">class_name</span><span class="p">])</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">outcome_col</span><span class="p">[</span><span class="n">outcome_col</span><span class="o">==</span><span class="n">class_name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">new_shapley_data</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span><span class="n">shap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,:],</span><span class="n">cpgs</span><span class="p">,</span><span class="n">n_top_cpgs</span><span class="p">,</span> <span class="n">add_top_negative</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_shapley_data</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.add_bin_continuous_classes"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.add_bin_continuous_classes">[docs]</a>    <span class="k">def</span> <span class="nf">add_bin_continuous_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bin continuous outcome variable and extract top positive and negative CpGs for each new class.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.add_abs_value_classes"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.add_abs_value_classes">[docs]</a>    <span class="k">def</span> <span class="nf">add_abs_value_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WIP.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.return_cpg_sets"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.return_cpg_sets">[docs]</a>    <span class="k">def</span> <span class="nf">return_cpg_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return top sets of CpGs from classes and individuals, and the complementary set. Returns dictionary of sets of CpGs and the union of all the other sets minus the current set.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cpg_sets</span>
<span class="sd">            Dictionary of individuals and classes; CpGs contained in set for particular individual/class</span>
<span class="sd">        cpg_exclusion_sets</span>
<span class="sd">            Dictionary of individuals and classes; CpGs not contained in set for particular individual/class</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
        <span class="k">def</span> <span class="nf">return_cpg_set</span><span class="p">(</span><span class="n">shap_df</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">shap_df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">cpg_sets</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">class_name</span><span class="p">,</span><span class="n">individuals</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_individuals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cpg_set</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">)[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span>
            <span class="k">for</span> <span class="n">individual</span> <span class="ow">in</span> <span class="n">individuals</span><span class="p">:</span>
                <span class="n">cpg_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_individual</span><span class="p">(</span><span class="n">individual</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="n">cpg_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">cpg_set</span><span class="p">))</span>
            <span class="n">cpg_sets</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpg_set</span>
        <span class="n">cpg_exclusion_sets</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">cpg_sets</span><span class="p">:</span>
            <span class="c1">#print(&quot;Calculating exclusion set for {}&quot;.format(class_name))</span>
            <span class="n">cpg_exclusion_sets</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">y</span><span class="p">),[</span><span class="n">cpg_set</span> <span class="k">for</span> <span class="n">class_name_query</span><span class="p">,</span><span class="n">cpg_set</span> <span class="ow">in</span> <span class="n">cpg_sets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">class_name_query</span> <span class="o">!=</span> <span class="n">class_name</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">cpg_sets</span><span class="p">,</span> <span class="n">cpg_exclusion_sets</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.extract_class"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.extract_class">[docs]</a>    <span class="k">def</span> <span class="nf">extract_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">class_intersect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the top cpgs from a class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        class_name : type</span>
<span class="sd">            Class to extract from?</span>
<span class="sd">        class_intersect : type</span>
<span class="sd">            Bool to extract from aggregation of SHAP values from individuals of current class, should have been done already.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataFrame</span>
<span class="sd">            Cpgs and SHAP Values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">class_intersect</span><span class="p">:</span>
            <span class="n">shap_dfs</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">individual</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">shap_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cpg&#39;</span><span class="p">))</span>
                <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">shap_dfs</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.extract_individual"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.extract_individual">[docs]</a>    <span class="k">def</span> <span class="nf">extract_individual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individual</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the top cpgs from an individual</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        individual : type</span>
<span class="sd">            Individual to extract from?</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple</span>
<span class="sd">            Class name of individual, DataFrame of Cpgs and SHAP Values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">class_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indiv2class</span><span class="p">[</span><span class="n">individual</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">class_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.regenerate_individual_shap_values"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.regenerate_individual_shap_values">[docs]</a>    <span class="k">def</span> <span class="nf">regenerate_individual_shap_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_cpgs</span><span class="p">,</span> <span class="n">abs_val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">neg_val</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use original SHAP scores to make nested dictionary of top CpGs based on shapley score, can do this for ABS SHAP or Negative SHAP scores as well.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_top_cpgs : type</span>
<span class="sd">            Description of parameter `n_top_cpgs`.</span>
<span class="sd">        abs_val : type</span>
<span class="sd">            Description of parameter `abs_val`.</span>
<span class="sd">        neg_val : type</span>
<span class="sd">            Description of parameter `neg_val`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shapley_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="p">)</span>
        <span class="n">mod_name</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_pos&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_neg&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">abs_val</span> <span class="k">else</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">abs_val</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abs_val</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">neg_val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">neg_val</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">new_class_name</span> <span class="o">=</span> <span class="n">mod_name</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
            <span class="n">cpgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">]))</span>
            <span class="n">shap_df</span><span class="o">=</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">]</span>
            <span class="n">shap_vals</span><span class="o">=</span><span class="n">abs_val</span><span class="p">(</span><span class="n">shap_df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">class_importance_shaps</span> <span class="o">=</span> <span class="n">abs_val</span><span class="p">(</span><span class="n">shap_vals</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">top_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">abs_val</span><span class="p">(</span><span class="n">class_importance_shaps</span><span class="p">)</span><span class="o">*</span><span class="n">neg_val</span><span class="p">)[:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
            <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">cpgs</span><span class="p">[</span><span class="n">top_idx</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">class_importance_shaps</span><span class="p">[</span><span class="n">top_idx</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]]),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">])</span>
            <span class="n">top_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">abs_val</span><span class="p">(</span><span class="n">shap_vals</span><span class="p">)</span><span class="o">*</span><span class="n">neg_val</span><span class="p">)[:,:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">individual</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">new_indiv_name</span> <span class="o">=</span> <span class="n">mod_name</span><span class="p">(</span><span class="n">individual</span><span class="p">)</span>
                <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">new_indiv_name</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">shap_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">top_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">,:]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">,</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">new_indiv_name</span> <span class="o">!=</span> <span class="n">individual</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span>
            <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">new_class_name</span><span class="p">]</span><span class="o">=</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">]</span>
            <span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">new_class_name</span><span class="p">]</span><span class="o">=</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">new_class_name</span> <span class="o">!=</span> <span class="n">class_name</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">],</span> <span class="n">shapley_data</span><span class="o">.</span><span class="n">shapley_values</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">shapley_data</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.view_methylation"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.view_methylation">[docs]</a>    <span class="k">def</span> <span class="nf">view_methylation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individual</span><span class="p">,</span> <span class="n">methyl_arr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use MethylationArray to output top SHAP values for individual with methylation data appended to output data frame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        individual : type</span>
<span class="sd">            Individual to query from ShapleyData</span>
<span class="sd">        methyl_arr : type</span>
<span class="sd">            Input MethylationArray</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        class_name</span>
<span class="sd">        individual</span>
<span class="sd">        top_shap_df</span>
<span class="sd">            Top Shapley DataFrame with top cpgs for individual, methylation data appended.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">class_name</span><span class="p">,</span><span class="n">top_shap_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_individual</span><span class="p">(</span><span class="n">individual</span><span class="p">)</span>
        <span class="n">top_shap_df</span><span class="p">[</span><span class="s1">&#39;methylation&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">methyl_arr</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">individual</span><span class="p">,</span><span class="n">top_shap_df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">class_name</span><span class="p">,</span><span class="n">individual</span><span class="p">,</span><span class="n">top_shap_df</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.extract_methylation_array"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.extract_methylation_array">[docs]</a>    <span class="k">def</span> <span class="nf">extract_methylation_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methyl_arr</span><span class="p">,</span> <span class="n">classes_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">global_vals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_extract</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">class_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subset MethylationArray Beta values by some top SHAP CpGs from classes or overall.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        methyl_arr : type</span>
<span class="sd">            MethylationArray.</span>
<span class="sd">        classes_only : type</span>
<span class="sd">            Setting this to False will include the overall top CpGs per class and the top CpGs for individuals in that class.</span>
<span class="sd">        global_vals : type</span>
<span class="sd">            Use top CpGs overall, across the entire dataset.</span>
<span class="sd">        n_extract : type</span>
<span class="sd">            Number of top CpGs to subset.</span>
<span class="sd">        class_name : type</span>
<span class="sd">            Which class to subset top CpGs from? Blank to use union of all top CpGs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MethylationArray</span>
<span class="sd">            Stores methylation beta and pheno data, reduced here by queried CpGs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
        <span class="n">total_cpgs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">global_vals</span><span class="p">:</span>
            <span class="n">all_cpgs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">][</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">n_extract</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cpgs</span><span class="p">):</span>
                <span class="n">all_cpgs</span><span class="o">=</span><span class="n">all_cpgs</span><span class="p">[:</span><span class="n">n_extract</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">class_name</span><span class="p">:</span>
                <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">class_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">:</span>
                <span class="n">cpgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">n_extract</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpgs</span><span class="p">):</span>
                    <span class="n">cpgs</span><span class="o">=</span><span class="n">cpgs</span><span class="p">[:</span><span class="n">n_extract</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">classes_only</span><span class="p">:</span>
                    <span class="n">cpgs</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,[</span><span class="n">cpgs</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                                              <span class="k">for</span> <span class="n">individual</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">total_cpgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpgs</span><span class="p">)</span>
            <span class="n">all_cpgs</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span><span class="n">total_cpgs</span><span class="p">)</span>
        <span class="n">methyl_arr</span><span class="o">.</span><span class="n">beta</span><span class="o">=</span><span class="n">methyl_arr</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">all_cpgs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">methyl_arr</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.limit_number_top_cpgs"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.limit_number_top_cpgs">[docs]</a>    <span class="k">def</span> <span class="nf">limit_number_top_cpgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_cpgs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduce the number of top CpGs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_top_cpgs : type</span>
<span class="sd">            Number top CpGs to retain.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ShapleyData</span>
<span class="sd">            Returns shapley data with fewer top CpGs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shapley_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">],</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]:</span>
            <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">individual</span> <span class="ow">in</span> <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]:</span>
                <span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span><span class="o">=</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">][</span><span class="n">individual</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n_top_cpgs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">shapley_data</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.list_individuals"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.list_individuals">[docs]</a>    <span class="k">def</span> <span class="nf">list_individuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List the individuals in the ShapleyData object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        return_list : type</span>
<span class="sd">            Return list of individual names rather than a dictionary of class:individual key-value pairs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List or Dictionary</span>
<span class="sd">            Class: Individual dictionary or individuals are elements of list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
            <span class="n">individuals</span><span class="o">=</span><span class="p">{</span><span class="n">class_name</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]}</span>
            <span class="k">return</span> <span class="n">individuals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]]))</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.list_classes"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.list_classes">[docs]</a>    <span class="k">def</span> <span class="nf">list_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List classes in ShapleyData object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List</span>
<span class="sd">            List of classes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">classes</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.return_top_cpgs"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.return_top_cpgs">[docs]</a>    <span class="k">def</span> <span class="nf">return_top_cpgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[],</span> <span class="n">individuals</span><span class="o">=</span><span class="p">[],</span> <span class="n">class_intersect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cpg_exclusion_sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cpg_sets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given list of classes and individuals, export a dictionary containing data frames of top CpGs and their SHAP scores.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        classes : type</span>
<span class="sd">            Higher level classes to extract CpGs from, list of classes to extract top CpGs from.</span>
<span class="sd">        individuals : type</span>
<span class="sd">            Individual samples to extract top CpGs from.</span>
<span class="sd">        class_intersect : type</span>
<span class="sd">            Whether the top CpGs should be chosen by aggregating the remaining individual scores.</span>
<span class="sd">        cpg_exclusion_sets : type</span>
<span class="sd">            Dict of sets of CpGs, where these ones contain CpGs not particular to particular class.</span>
<span class="sd">        cpg_sets : type</span>
<span class="sd">            Contains top CpGs found for each class.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict</span>
<span class="sd">            Top CpGs accessed and returned for further processing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top_cpgs</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                <span class="n">top_cpg_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">class_intersect</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cpg_exclusion_sets</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unique_cpgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">top_cpg_df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">-</span><span class="n">cpg_exclusion_sets</span><span class="p">[</span><span class="n">class_name</span><span class="p">]))</span>
                    <span class="n">top_cpgs</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">=</span> <span class="n">top_cpg_df</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_cpg_df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">unique_cpgs</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">top_cpgs</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">=</span> <span class="n">top_cpg_df</span>
        <span class="k">if</span> <span class="n">individuals</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indiv</span> <span class="ow">in</span> <span class="n">individuals</span><span class="p">:</span>
                <span class="n">class_name</span><span class="p">,</span><span class="n">top_cpg_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_individual</span><span class="p">(</span><span class="n">indiv</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cpg_exclusion_sets</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unique_cpgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">top_cpg_df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">-</span><span class="n">cpg_exclusion_sets</span><span class="p">[</span><span class="n">class_name</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_cpg_df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_cpgs</span><span class="p">))</span>
                    <span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span><span class="n">indiv</span><span class="p">)]</span><span class="o">=</span><span class="n">top_cpg_df</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_cpg_df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">unique_cpgs</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span><span class="n">indiv</span><span class="p">)]</span><span class="o">=</span><span class="n">top_cpg_df</span>
        <span class="k">if</span> <span class="n">cpg_sets</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cpg_sets</span><span class="p">)</span>
            <span class="n">intersected_cpgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">cpg_sets</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
            <span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;intersection&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">intersected_cpgs</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">])</span>
            <span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;intersection&#39;</span><span class="p">][</span><span class="s1">&#39;shapley_value&#39;</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">top_cpgs</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.return_global_importance_cpgs"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.return_global_importance_cpgs">[docs]</a>    <span class="k">def</span> <span class="nf">return_global_importance_cpgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return overall globally important CpGs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="ShapleyDataExplorer.jaccard_similarity_top_cpgs"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.ShapleyDataExplorer.jaccard_similarity_top_cpgs">[docs]</a>    <span class="k">def</span> <span class="nf">jaccard_similarity_top_cpgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">class_names</span><span class="p">,</span><span class="n">individuals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">overall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cooccurrence</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Jaccard Similarity matrix between classes and individuals within those classes based on how they share sets of CpGs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        class_names : type</span>
<span class="sd">            Classes to include.</span>
<span class="sd">        individuals : type</span>
<span class="sd">            Individuals to include.</span>
<span class="sd">        overall : type</span>
<span class="sd">            Whether to use overall class top CpGs versus aggregate.</span>
<span class="sd">        cooccurrence : type</span>
<span class="sd">            Output cooccurence instead of jaccard.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Similarity matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">combinations</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
        <span class="n">x</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">class_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">class_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">class_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">overall</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;overall&#39;</span><span class="p">][</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">individuals</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">indiv</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="s1">&#39;by_class&#39;</span><span class="p">][</span><span class="n">class_name</span><span class="p">][</span><span class="s1">&#39;by_individual&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span><span class="n">indiv</span><span class="p">)]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cpg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">indivs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">similarity_matrix</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="n">index</span><span class="o">=</span><span class="n">indivs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">indivs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">indivs</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">jaccard_similarity</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cooccurrence</span> <span class="k">else</span> <span class="n">cooccurrence_fn</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cooccurrence</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indivs</span><span class="p">:</span>
                <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">similarity_matrix</span></div></div>

<div class="viewcode-block" id="jaccard_similarity"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.jaccard_similarity">[docs]</a><span class="k">def</span> <span class="nf">jaccard_similarity</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Jaccard score between two lists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    list1</span>
<span class="sd">    list2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Jaccard similarity between elements in list.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span></div>

<div class="viewcode-block" id="cooccurrence_fn"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.cooccurrence_fn">[docs]</a><span class="k">def</span> <span class="nf">cooccurrence_fn</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span><span class="n">list2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cooccurence of elements between two lists.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    list1</span>
<span class="sd">    list2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Cooccurence between elements in list.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">)))</span></div>

<div class="viewcode-block" id="PlotCircos"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.PlotCircos">[docs]</a><span class="k">class</span> <span class="nc">PlotCircos</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Plot Circos Diagram using ggbio (regular circos software may be better)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    generate_base_plot : type</span>
<span class="sd">        Function to generate base plot</span>
<span class="sd">    add_plot_data : type</span>
<span class="sd">        Function to add more plot data</span>
<span class="sd">    generate_final_plot : type</span>
<span class="sd">        Function to plot data using Circos</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">import</span> <span class="n">importr</span>
        <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
        <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ggbio</span><span class="o">=</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;ggbio&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;data(&quot;CRC&quot;, package = &quot;biovizBase&quot;)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hg19</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;IlluminaHumanMethylation450kanno.ilmn12.hg19&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GRanges</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;GenomicRanges&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_base_plot</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;function () {</span>
<span class="s2">                                p &lt;- ggbio()</span>
<span class="s2">                                return(p)}&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_plot_data</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;function(p_data_new, p_data=c()) {</span>
<span class="s2">                                        p_data=c(p_data,p_data_new)</span>
<span class="s2">                                        return(p_data)</span>
<span class="s2">                                        }&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_final_plot</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;function(p,grs) {</span>
<span class="s2">                                              p&lt;- ggbio()</span>
<span class="s2">                                              for (gr in grs) {</span>
<span class="s2">                                              seqlevelsStyle(gr)&lt;-&quot;NCBI&quot;</span>
<span class="s2">                                              p&lt;-p+circle(gr, geom = &quot;rect&quot;, color = &quot;steelblue&quot;)</span>
<span class="s2">                                              }</span>
<span class="s2">                                               p&lt;-p + circle(hg19sub,geom = &quot;ideo&quot;, fill = &quot;gray70&quot;) + circle(hg19sub,geom = &quot;scale&quot;, size = 2)+</span>
<span class="s2">                                                circle(hg19sub,geom = &quot;text&quot;, aes(label = seqnames), vjust = 0, size = 3)</span>
<span class="s2">                                               return(p)}&quot;&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PlotCircos.plot_cpgs"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.PlotCircos.plot_cpgs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_cpgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_cpgs</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot top CpGs location in genome.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        top_cpgs : type</span>
<span class="sd">            Input dataframe of top CpG name and SHAP scores. Future: Plot SHAP scores in locations?</span>
<span class="sd">        output_dir : type</span>
<span class="sd">            Where to output plots.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
        <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span> <span class="o">=</span> <span class="n">top_cpgs</span>
        <span class="n">cpg_locations</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">](</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)&#39;</span><span class="p">),</span><span class="s1">&#39;data.frame&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cpg_locations</span><span class="p">)</span>
        <span class="n">cpgs_grange</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;makeGRangesFromDataFrame&#39;</span><span class="p">)(</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">cpg_locations</span><span class="p">),</span><span class="n">start_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">end_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">starts_in_df_are_0based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">output_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">plots</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_base_plot</span><span class="p">()</span>
        <span class="c1">#ggsave = robjects.r(&quot;&quot;&quot;function (file.name, p) {ggsave(file.name,p)}&quot;&quot;&quot;)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">list_cpgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cpg_location_subset</span> <span class="o">=</span> <span class="n">cpg_locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">list_cpgs</span><span class="p">,:]</span>
            <span class="n">location_subset</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;makeGRangesFromDataFrame&#39;</span><span class="p">)(</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">cpg_location_subset</span><span class="p">),</span><span class="n">start_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">end_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">starts_in_df_are_0based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">locations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">add_plot_data</span><span class="p">(</span><span class="n">location_subset</span><span class="p">,</span><span class="n">locations</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_plot_data</span><span class="p">(</span><span class="n">location_subset</span><span class="p">)</span>
            <span class="c1">#self.add_plot(p,location_subset)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_final_plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">locations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ggbio</span><span class="o">.</span><span class="n">ggsave</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">]))))</span></div></div>

<div class="viewcode-block" id="CpGExplainer"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer">[docs]</a><span class="k">class</span> <span class="nc">CpGExplainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Produces SHAPley explanation scores for individual predictions, approximating a complex model with a basic linear one, one coefficient per CpG per individual.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prediction_function : type</span>
<span class="sd">        Model or function that makes predictions on the data, can be sklearn .predict method or pytorch forward pass, etc...</span>
<span class="sd">    cuda : type</span>
<span class="sd">        Run on GPUs?</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    explainer : type</span>
<span class="sd">        Type of SHAPley explanation method; kernel (uses LIME model agnostic explainer), deep (uses DeepLift) or Gradient (integrated gradients and backprop for explanations)?</span>
<span class="sd">    prediction_function</span>
<span class="sd">    cuda</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># consider shap.kmeans or grab representative sample of each outcome in training set for background ~ 39 * 2 samples, 39 cancers, should speed things up, small training set when building explainer https://github.com/slundberg/shap/issues/372</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prediction_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cuda</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_function</span><span class="o">=</span><span class="n">prediction_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span> <span class="o">=</span> <span class="n">cuda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">=</span><span class="kc">None</span>

<div class="viewcode-block" id="CpGExplainer.build_explainer"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer.build_explainer">[docs]</a>    <span class="k">def</span> <span class="nf">build_explainer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_methyl_array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> <span class="c1"># can interpret latent dimensions</span>
        <span class="sd">&quot;&quot;&quot;Builds SHAP explainer using background samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        train_methyl_array : type</span>
<span class="sd">            Train Methylation Array from which to populate background samples to make estimated explanations.</span>
<span class="sd">        method : type</span>
<span class="sd">            SHAP explanation method?</span>
<span class="sd">        batch_size : type</span>
<span class="sd">            Break up prediction explanation creation into smaller batch sizes for lower memory consumption.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span><span class="s1">&#39;kernel&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">=</span><span class="n">shap</span><span class="o">.</span><span class="n">KernelExplainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_function</span><span class="p">,</span> <span class="n">train_methyl_array</span><span class="o">.</span><span class="n">return_raw_beta_array</span><span class="p">(),</span> <span class="n">link</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;deep&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">=</span><span class="n">shap</span><span class="o">.</span><span class="n">DeepExplainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_function</span><span class="p">,</span> <span class="n">to_tensor</span><span class="p">(</span><span class="n">train_methyl_array</span><span class="o">.</span><span class="n">return_raw_beta_array</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span> <span class="k">else</span> <span class="n">to_tensor</span><span class="p">(</span><span class="n">train_methyl_array</span><span class="o">.</span><span class="n">return_raw_beta_array</span><span class="p">())</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gradient&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">=</span><span class="n">shap</span><span class="o">.</span><span class="n">GradientExplainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_function</span><span class="p">,</span> <span class="n">to_tensor</span><span class="p">(</span><span class="n">train_methyl_array</span><span class="o">.</span><span class="n">return_raw_beta_array</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span> <span class="k">else</span> <span class="n">to_tensor</span><span class="p">(</span><span class="n">train_methyl_array</span><span class="o">.</span><span class="n">return_raw_beta_array</span><span class="p">())</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not Implemented, default to kernel explainer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;kernel&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="o">=</span><span class="n">shap</span><span class="o">.</span><span class="n">KernelExplainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prediction_function</span><span class="p">,</span> <span class="n">train_methyl_array</span><span class="o">.</span><span class="n">return_raw_beta_array</span><span class="p">(),</span> <span class="n">link</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CpGExplainer.return_shapley_scores"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer.return_shapley_scores">[docs]</a>    <span class="k">def</span> <span class="nf">return_shapley_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_methyl_array</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">,</span> <span class="n">shap_sample_batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># split up into multiple methods</span>
        <span class="sd">&quot;&quot;&quot;Generate explanations for individual predictions, in the form of SHAPley scores for supplied test data.</span>
<span class="sd">        One SHAP score per individual prediction per CpG, and more if multiclass/output.</span>
<span class="sd">        For multiclass/multivariate outcomes, scores are generated for each outcome class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_methyl_array : type</span>
<span class="sd">            Testing MethylationArray.</span>
<span class="sd">        n_samples : type</span>
<span class="sd">            Number of SHAP score samples to produce. More SHAP samples provides convergence to correct score.</span>
<span class="sd">        n_outputs : type</span>
<span class="sd">            Number of outcome classes.</span>
<span class="sd">        shap_sample_batch_size : type</span>
<span class="sd">            If not None, break up SHAP score sampling into batches of this size to be averaged.</span>
<span class="sd">        top_outputs : type</span>
<span class="sd">            For deep explainer, limit number of output classes due to memory consumption.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_batch</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">shap_sample_batch_size</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;deep&#39;</span><span class="p">:</span> <span class="c1">#  and not feature_selection</span>
            <span class="n">n_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_samples</span><span class="o">/</span><span class="n">shap_sample_batch_size</span><span class="p">)</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="n">shap_sample_batch_size</span>
        <span class="n">test_arr</span> <span class="o">=</span> <span class="n">test_methyl_array</span><span class="o">.</span><span class="n">return_raw_beta_array</span><span class="p">()</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">top_outputs</span> <span class="k">if</span> <span class="n">top_outputs</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">n_outputs</span><span class="p">,)</span><span class="o">+</span><span class="n">test_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">additional_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;kernel&#39;</span><span class="p">:</span>
            <span class="n">additional_opts</span><span class="p">[</span><span class="s1">&#39;ranked_outputs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">top_outputs</span>
            <span class="n">test_arr</span><span class="o">=</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">test_arr</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda</span> <span class="k">else</span> <span class="n">to_tensor</span><span class="p">(</span><span class="n">test_arr</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batch</span><span class="p">):</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Batch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">shap_values</span> <span class="o">+=</span> <span class="n">return_shap_values</span><span class="p">(</span><span class="n">test_arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">additional_opts</span><span class="p">)</span>
        <span class="n">shap_values</span><span class="o">/=</span><span class="nb">float</span><span class="p">(</span><span class="n">n_batch</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_values</span></div>

<div class="viewcode-block" id="CpGExplainer.classifier_assign_scores_to_shap_data"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer.classifier_assign_scores_to_shap_data">[docs]</a>    <span class="k">def</span> <span class="nf">classifier_assign_scores_to_shap_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_methyl_array</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">,</span> <span class="n">interest_col</span><span class="o">=</span><span class="s1">&#39;disease&#39;</span><span class="p">,</span> <span class="n">prediction_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns the SHAP scores to a SHAPley data object, populating nested dictionaries (containing class-individual information) with SHAPley information and &quot;top CpGs&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_methyl_array : type</span>
<span class="sd">            Testing MethylationArray.</span>
<span class="sd">        n_top_features : type</span>
<span class="sd">            Number of top SHAP scores to use for a subdict called &quot;top CpGs&quot;</span>
<span class="sd">        interest_col : type</span>
<span class="sd">            Column in pheno sheet from which class names reside.</span>
<span class="sd">        prediction_classes : type</span>
<span class="sd">            User supplied prediction classes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cpgs</span><span class="o">=</span><span class="n">test_methyl_array</span><span class="o">.</span><span class="n">return_cpgs</span><span class="p">()</span>
        <span class="n">shapley_data</span> <span class="o">=</span> <span class="n">ShapleyData</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cpg_global_shapley_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shapley_data</span><span class="o">.</span><span class="n">add_global_importance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpg_global_shapley_scores</span><span class="p">,</span><span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;if cross_class:</span>
<span class="sd">            self.shap_values = np.abs(self.shap_values).mean(axis=0)&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">prediction_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">prediction_classes</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">shap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">test_methyl_array</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cpgs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shap_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">prediction_classes</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">shap_df</span> <span class="o">=</span> <span class="n">shap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_methyl_array</span><span class="o">.</span><span class="n">pheno</span><span class="p">[</span><span class="n">interest_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">class_name</span><span class="p">,:]</span>
                <span class="n">shapley_data</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">shap_df</span><span class="p">,</span> <span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span> <span class="o">=</span> <span class="n">shapley_data</span></div>

<div class="viewcode-block" id="CpGExplainer.regressor_assign_scores_to_shap_data"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer.regressor_assign_scores_to_shap_data">[docs]</a>    <span class="k">def</span> <span class="nf">regressor_assign_scores_to_shap_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_methyl_array</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">,</span> <span class="n">cell_names</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Assigns the SHAP scores to a SHAPley data object, populating nested dictionaries (containing multioutput and single output regression-individual information) with SHAPley information and &quot;top CpGs&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_methyl_array : type</span>
<span class="sd">            Testing MethylationArray.</span>
<span class="sd">        n_top_features : type</span>
<span class="sd">            Number of top SHAP scores to use for a subdict called &quot;top CpGs&quot;</span>
<span class="sd">        cell_names : type</span>
<span class="sd">            If multi-output regression, create separate regression classes to access for all individuals.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_classes</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">cpgs</span><span class="o">=</span><span class="n">test_methyl_array</span><span class="o">.</span><span class="n">return_cpgs</span><span class="p">()</span>

        <span class="n">shapley_data</span> <span class="o">=</span> <span class="n">ShapleyData</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cpg_global_shapley_scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_classes</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">shapley_data</span><span class="o">.</span><span class="n">add_global_importance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpg_global_shapley_scores</span><span class="p">,</span><span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_classes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_names</span> <span class="k">else</span> <span class="n">cell_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">shap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">test_methyl_array</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cpgs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">shap_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">shapley_data</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_pos&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">),</span> <span class="n">shap_df</span><span class="p">,</span> <span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">)</span>
                    <span class="n">shapley_data</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_neg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">),</span> <span class="n">shap_df</span><span class="p">,</span> <span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">,</span> <span class="n">add_top_negative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># regression tasks</span>
            <span class="n">shap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shap_values</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">test_methyl_array</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cpgs</span><span class="p">)</span>
            <span class="n">shapley_data</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span><span class="s1">&#39;regression_pos&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_names</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_pos&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shap_df</span><span class="p">,</span> <span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">)</span>
            <span class="n">shapley_data</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span><span class="s1">&#39;regression_neg&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_names</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_neg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shap_df</span><span class="p">,</span> <span class="n">cpgs</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">,</span> <span class="n">add_top_negative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shapley_data</span> <span class="o">=</span> <span class="n">shapley_data</span></div>

<div class="viewcode-block" id="CpGExplainer.feature_select"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer.feature_select">[docs]</a>    <span class="k">def</span> <span class="nf">feature_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methyl_array</span><span class="p">,</span> <span class="n">n_top_features</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform feature selection based on the best overall SHAP scores across all samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        methyl_array : type</span>
<span class="sd">            MethylationArray to run feature selection on.</span>
<span class="sd">        n_top_features : type</span>
<span class="sd">            Number of CpGs to select.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MethylationArray</span>
<span class="sd">            Subsetted by top overall CpGs, overall positive contributions to prediction. May need to update.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cpgs</span> <span class="o">=</span> <span class="n">methyl_array</span><span class="o">.</span><span class="n">return_cpgs</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cpgs</span><span class="p">)</span>
        <span class="n">cpgs</span><span class="o">=</span><span class="n">cpgs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpg_global_shapley_scores</span><span class="o">*-</span><span class="mi">1</span><span class="p">)[:</span><span class="n">n_top_features</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cpgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">methyl_array</span><span class="o">.</span><span class="n">subset_cpgs</span><span class="p">(</span><span class="n">cpgs</span><span class="p">)</span></div>

<div class="viewcode-block" id="CpGExplainer.return_shapley_predictions"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer.return_shapley_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">return_shapley_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_methyl_array</span><span class="p">,</span> <span class="n">sample_name</span><span class="p">,</span> <span class="n">interest_col</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method in development or may be deprecated.&quot;&quot;&quot;</span>
        <span class="n">prediction_class</span> <span class="o">=</span> <span class="n">test_methyl_array</span><span class="p">[</span><span class="s1">&#39;pheno&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_name</span><span class="p">,</span><span class="n">interest_col</span><span class="p">]</span>
        <span class="n">prediction_class_labelled</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">encoder</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prediction_class_labelled</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">prediction_class</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;In development&quot;</span></div>

<div class="viewcode-block" id="CpGExplainer.from_explainer"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.CpGExplainer.from_explainer">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_explainer</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">cuda</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load custom SHAPley explainer&quot;&quot;&quot;</span>
        <span class="n">cpg_explainer</span> <span class="o">=</span> <span class="n">CpGExplainer</span><span class="p">(</span><span class="n">cuda</span><span class="o">=</span><span class="n">cuda</span><span class="p">)</span>
        <span class="n">cpg_explainer</span><span class="o">.</span><span class="n">explainer</span> <span class="o">=</span> <span class="n">explainer</span>
        <span class="k">return</span> <span class="n">cpg_explainer</span></div></div>


<div class="viewcode-block" id="BioInterpreter"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.BioInterpreter">[docs]</a><span class="k">class</span> <span class="nc">BioInterpreter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Interrogate CpGs found to be important from SHAP through enrichment and overlap tests.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dict_top_cpgs : type</span>
<span class="sd">        Dictionary of topCpGs output from ShapleyExplorer object</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    top_cpgs : type</span>
<span class="sd">        Dictionary of top cpgs to be interrogated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_top_cpgs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span> <span class="o">=</span> <span class="n">dict_top_cpgs</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">import</span> <span class="n">importr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hg19</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;IlluminaHumanMethylation450kanno.ilmn12.hg19&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GRanges</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;GenomicRanges&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missMethyl</span><span class="o">=</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;missMethyl&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limma</span><span class="o">=</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;limma&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lola</span><span class="o">=</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;LOLA&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">=</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;FlowSorted.Blood.EPIC&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cgager</span><span class="o">=</span><span class="n">importr</span><span class="p">(</span><span class="s1">&#39;cgageR&#39;</span><span class="p">)</span>

        <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;simpleCache&#39;</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;if self.prediction_classes == None:</span>
<span class="sd">            self.prediction_classes = list(range(len(self.top_cpgs)))</span>
<span class="sd">        else:</span>
<span class="sd">            self.prediction_classes=list(map(lambda x: x.replace(&#39; &#39;,&#39;&#39;),prediction_classes))&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BioInterpreter.gometh"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.BioInterpreter.gometh">[docs]</a>    <span class="k">def</span> <span class="nf">gometh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;GO&#39;</span><span class="p">,</span> <span class="n">allcpgs</span><span class="o">=</span><span class="p">[],</span> <span class="n">length_output</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">gsea_analyses</span><span class="o">=</span><span class="p">[],</span> <span class="n">gsea_pickle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span><span class="c1"># consider turn into generator go or kegg # add rgreat, lola, roadmap-chromatin hmm, atac-seq, chip-seq, gometh, Hi-C, bedtools, Owen&#39;s analysis</span>
        <span class="sd">&quot;&quot;&quot;Run GO, KEGG, GSEA analyses or return nearby genes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        collection : type</span>
<span class="sd">            GO, KEGG, GSEA, GENE overlaps?</span>
<span class="sd">        allcpgs : type</span>
<span class="sd">            All CpGs defines CpG universe, empty if use all CpGs, smaller group of CpGs may yield more significant results.</span>
<span class="sd">        length_output : type</span>
<span class="sd">            How many lines should the output be, maximum number of results to print.</span>
<span class="sd">        gsea_analyses : type</span>
<span class="sd">            GSEA analyses/collections to target.</span>
<span class="sd">        gsea_pickle : type</span>
<span class="sd">            Location of gsea pickle containing gene sets, may need to run download_help_data to acquire.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict</span>
<span class="sd">            Dictionary containing results from each test run on all of the keys in top_cpgs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
        <span class="c1">#robjects.packages.importr(&#39;org.Hs.eg.db&#39;)</span>
        <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="n">output_dfs</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">allcpgs</span><span class="p">:</span>
            <span class="n">allcpgs</span><span class="o">=</span><span class="n">robjects</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">allcpgs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allcpgs</span><span class="o">=</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gsea_analyses</span><span class="p">:</span>
            <span class="n">gsea_collections</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">gsea_pickle</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">))</span>
            <span class="n">gene_sets</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="n">gsea_analyses</span><span class="p">:</span>
                <span class="n">gene_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">gsea_collections</span><span class="p">[</span><span class="n">analysis</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">gene_sets</span><span class="o">=</span><span class="n">robjects</span><span class="o">.</span><span class="n">ListVector</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">gene_sets</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">:</span>
            <span class="n">list_cpgs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start Prediction </span><span class="si">{}</span><span class="s1"> BIO&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">list_cpgs</span><span class="o">=</span><span class="n">robjects</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">list_cpgs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s1">&#39;GENE&#39;</span><span class="p">:</span>
                <span class="n">mappedEz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missMethyl</span><span class="o">.</span><span class="n">getMappedEntrezIDs</span><span class="p">(</span><span class="n">sig_cpg</span><span class="o">=</span><span class="n">list_cpgs</span><span class="p">,</span> <span class="n">all_cpg</span> <span class="o">=</span> <span class="n">allcpgs</span><span class="p">,</span> <span class="n">array_type</span><span class="o">=</span><span class="s1">&#39;450K&#39;</span><span class="p">)</span>
                <span class="n">gometh_output</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;function (mappedEz, length.output) {data.frame(mappedEz$sig.eg[1:length.output])}&#39;</span><span class="p">)(</span><span class="n">mappedEz</span><span class="p">,</span><span class="n">length_output</span><span class="p">)</span> <span class="c1"># sig.eg[1:10]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">gometh_output</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GO&#39;</span><span class="p">,</span><span class="s1">&#39;KEGG&#39;</span><span class="p">]:</span>
                <span class="n">gometh_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missMethyl</span><span class="o">.</span><span class="n">gometh</span><span class="p">(</span><span class="n">sig_cpg</span><span class="o">=</span><span class="n">list_cpgs</span><span class="p">,</span><span class="n">all_cpg</span><span class="o">=</span><span class="n">allcpgs</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span><span class="n">prior_prob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">gometh_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limma</span><span class="o">.</span><span class="n">topKEGG</span><span class="p">(</span><span class="n">gometh_output</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">length_output</span><span class="p">)</span> <span class="k">if</span> <span class="n">collection</span><span class="o">==</span><span class="s1">&#39;KEGG&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">limma</span><span class="o">.</span><span class="n">topGO</span><span class="p">(</span><span class="n">gometh_output</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">length_output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gometh_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missMethyl</span><span class="o">.</span><span class="n">gsameth</span><span class="p">(</span><span class="n">sig_cpg</span><span class="o">=</span><span class="n">list_cpgs</span><span class="p">,</span><span class="n">all_cpg</span><span class="o">=</span><span class="n">allcpgs</span><span class="p">,</span><span class="n">collection</span><span class="o">=</span><span class="n">gene_sets</span><span class="p">,</span><span class="n">prior_prob</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">gometh_output</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;as.table&#39;</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">missMethyl</span><span class="o">.</span><span class="n">topGSA</span><span class="p">(</span><span class="n">gometh_output</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">length_output</span><span class="p">))</span>
                <span class="c1">#robjects.r(&#39;print&#39;)(gometh_output)</span>
            <span class="c1"># FIXME add get genes</span>
            <span class="c1"># genes = self.missMethyl.getMappedEntrezIDs(sig.cpg, all.cpg = NULL, array.type, anno = NULL)</span>
            <span class="n">output_dfs</span><span class="p">[</span><span class="s1">&#39;prediction_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">=</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">](</span><span class="n">gometh_output</span><span class="p">,</span><span class="s1">&#39;data.frame&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">gsea_analyses</span> <span class="k">else</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;as.data.frame&#39;</span><span class="p">)(</span><span class="n">gometh_output</span><span class="p">))</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Var1&#39;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Var2&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;Freq&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;P.DE&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output_dfs</span><span class="p">[</span><span class="s1">&#39;prediction_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
            <span class="c1">#print(&#39;GO/KEGG/GSEA Computed for Prediction {} Cpgs: {}&#39;.format(k, &#39; &#39;.join(list_cpgs)))</span>
        <span class="k">return</span> <span class="n">output_dfs</span></div>

<div class="viewcode-block" id="BioInterpreter.get_nearby_cpg_shapleys"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.BioInterpreter.get_nearby_cpg_shapleys">[docs]</a>    <span class="k">def</span> <span class="nf">get_nearby_cpg_shapleys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_cpgs</span><span class="p">,</span> <span class="n">max_gap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query for CpGs that are within a max_gap of the topCpGs in the genome, helps find cpgs that could be highly correlated and thus also important.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        all_cpgs : type</span>
<span class="sd">            List of all cpgs in methylationarray.</span>
<span class="sd">        max_gap : type</span>
<span class="sd">            Max radius to search for nearby CpGs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict</span>
<span class="sd">            Results for each class/indiv&#39;s top CpGs, in the form of nearby CpGs to each of these CpGs sets.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
        <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="n">cpg_locations</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">](</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)&#39;</span><span class="p">),</span><span class="s1">&#39;data.frame&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cpgs_grange</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;makeGRangesFromDataFrame&#39;</span><span class="p">)(</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">cpg_locations</span><span class="p">),</span><span class="n">start_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">end_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">starts_in_df_are_0based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">output_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">:</span>
            <span class="n">cpg_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
            <span class="n">list_cpgs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cpg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="n">cpg_location_subset</span> <span class="o">=</span> <span class="n">cpg_locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">list_cpgs</span><span class="p">,:]</span>
            <span class="n">location_subset</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;makeGRangesFromDataFrame&#39;</span><span class="p">)(</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">cpg_location_subset</span><span class="p">),</span><span class="n">start_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">end_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">starts_in_df_are_0based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cpgs_overlap</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">GRanges</span><span class="o">.</span><span class="n">findOverlaps</span><span class="p">(</span><span class="n">cpgs_grange</span><span class="p">,</span><span class="n">location_subset</span><span class="p">,</span><span class="n">maxgap</span><span class="o">=</span><span class="n">max_gap</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">),</span><span class="s1">&#39;data.frame&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cpg</span> <span class="ow">in</span> <span class="n">cpgs_overlap</span><span class="p">:</span>
                <span class="n">cpg_dict</span><span class="p">[</span><span class="n">cpg</span><span class="p">]</span>
            <span class="n">top_cpgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cpg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">output_dfs</span><span class="p">[</span><span class="s1">&#39;prediction_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">top_cpgs</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CpG&#39;</span><span class="p">,</span><span class="s1">&#39;Shapley Value&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">output_dfs</span></div>

<div class="viewcode-block" id="BioInterpreter.return_overlap_score"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.BioInterpreter.return_overlap_score">[docs]</a>    <span class="k">def</span> <span class="nf">return_overlap_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_cpgs</span><span class="o">=</span><span class="s1">&#39;IDOL&#39;</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;450k&#39;</span><span class="p">,</span> <span class="n">all_cpgs</span><span class="o">=</span><span class="p">[],</span> <span class="n">output_csv</span><span class="o">=</span><span class="s1">&#39;output_bio_intersect.csv&#39;</span><span class="p">,</span> <span class="n">extract_library</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform overlap test, overlapping top CpGs with IDOL CpGs, age related cpgs, etc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        set_cpgs : type</span>
<span class="sd">            Set of reference cpgs.</span>
<span class="sd">        platform : type</span>
<span class="sd">            450K or 850K</span>
<span class="sd">        all_cpgs : type</span>
<span class="sd">            All CpGs to build a universe.</span>
<span class="sd">        output_csv : type</span>
<span class="sd">            Output CSV for results of overlaps between classes, how much doo they share these CpGs overlapped.</span>
<span class="sd">        extract_library : type</span>
<span class="sd">            Can extract a list of the CpGs that ended up beinng overlapped with.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List</span>
<span class="sd">            Optional output of overlapped library of CpGs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
        <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">set_cpgs</span> <span class="o">==</span> <span class="s1">&#39;IDOL&#39;</span><span class="p">:</span>
            <span class="n">cpg_reference_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;IDOLOptimizedCpGs&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">platform</span><span class="o">==</span><span class="s1">&#39;epic&#39;</span> <span class="k">else</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;IDOLOptimizedCpGs450klegacy&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">set_cpgs</span> <span class="o">==</span> <span class="s1">&#39;clock&#39;</span><span class="p">:</span>
            <span class="n">cpg_reference_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/age_cpgs.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="c1"># clock</span>
        <span class="k">elif</span> <span class="n">set_cpgs</span> <span class="o">==</span> <span class="s1">&#39;epitoc&#39;</span><span class="p">:</span>
            <span class="n">cpg_reference_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;EpiTOCcpgs&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">set_cpgs</span> <span class="o">==</span> <span class="s1">&#39;horvath&#39;</span><span class="p">:</span>
            <span class="n">cpg_reference_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;as.vector(HorvathLongCGlist$MR_var)&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">set_cpgs</span> <span class="o">==</span> <span class="s1">&#39;hannum&#39;</span><span class="p">:</span>
            <span class="n">cpg_reference_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;as.vector(hannumModel$marker)&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpg_reference_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;as.vector(HorvathLongCGlist$MR_var)&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">all_cpgs</span><span class="p">:</span>
            <span class="n">cpg_reference_set</span> <span class="o">=</span> <span class="n">cpg_reference_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">all_cpgs</span><span class="p">)</span>
        <span class="n">intersected_cpg_sets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">:</span>
            <span class="n">query_cpgs</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">intersected_cpgs</span><span class="o">=</span><span class="n">query_cpgs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cpg_reference_set</span><span class="p">)</span>
            <span class="n">intersected_cpg_sets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">intersected_cpgs</span>
            <span class="n">overlap_score</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intersected_cpgs</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpg_reference_set</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> top cpgs overlap with </span><span class="si">{}% o</span><span class="s2">f </span><span class="si">{}</span><span class="s2"> cpgs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">overlap_score</span><span class="p">,</span><span class="n">set_cpgs</span><span class="p">))</span>

        <span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">intersected_cpg_sets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">combinations</span>
            <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
            <span class="n">similarity_matrix</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)),</span><span class="n">index</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">intersected_cpg_sets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">intersected_cpg_sets</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">intersected_cpg_sets</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> shared cpgs: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">y</span><span class="p">),[</span><span class="n">intersected_cpg_sets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">intersected_cpgs</span><span class="p">)</span> <span class="k">for</span> <span class="n">k2</span><span class="p">,</span><span class="n">intersected_cpgs</span> <span class="ow">in</span> <span class="n">intersected_cpg_sets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k2</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]))),</span><span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]))</span>
            <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">keys</span><span class="p">)]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extract_library</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,[</span><span class="nb">list</span><span class="p">(</span><span class="n">intersected_cpg_sets</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BioInterpreter.run_lola"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.BioInterpreter.run_lola">[docs]</a>    <span class="k">def</span> <span class="nf">run_lola</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_cpgs</span><span class="o">=</span><span class="p">[],</span> <span class="n">lola_db</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="p">[],</span><span class="n">depletion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run LOLA enrichment test.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        all_cpgs : type</span>
<span class="sd">            CpG universe for LOLA.</span>
<span class="sd">        lola_db : type</span>
<span class="sd">            Location of LOLA database, can be downloaded using methylnet-interpret. Set to extended or core, and collections correspond to these.</span>
<span class="sd">        cores : type</span>
<span class="sd">            Number of cores to use.</span>
<span class="sd">        collections : type</span>
<span class="sd">            LOLA collections to run, leave empty to run all.</span>
<span class="sd">        depletion : type</span>
<span class="sd">            Set true to look for depleted regions over enriched.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        type</span>
<span class="sd">            Description of returned object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="k">as</span> <span class="nn">robjects</span>
        <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
        <span class="n">order_by_max_rnk</span><span class="o">=</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;function (dt) </span><span class="si">{dt[order(meanRnk, decreasing=FALSE),]}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="n">cpg_locations</span> <span class="o">=</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">](</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)&#39;</span><span class="p">),</span><span class="s1">&#39;data.frame&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">all_cpg_regions</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;makeGRangesFromDataFrame&#39;</span><span class="p">)(</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">cpg_locations</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">all_cpgs</span> <span class="k">else</span> <span class="n">cpg_locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_cpgs</span><span class="p">,:]),</span><span class="n">start_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">end_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">starts_in_df_are_0based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1">#robjects.r(&#39;load(&quot;{}&quot;)&#39;.format(lola_rdata))</span>
        <span class="n">lolaDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lola</span><span class="o">.</span><span class="n">loadRegionDB</span><span class="p">(</span><span class="n">lola_db</span><span class="p">,</span><span class="n">collections</span><span class="o">=</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">collections</span> <span class="k">else</span> <span class="n">rpy2</span><span class="o">.</span><span class="n">robjects</span><span class="o">.</span><span class="n">vectors</span><span class="o">.</span><span class="n">StrVector</span><span class="p">(</span><span class="n">collections</span><span class="p">)))</span><span class="c1">#</span>
        <span class="n">output_dfs</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">:</span>
            <span class="n">list_cpgs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">top_cpgs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cpg_location_subset</span> <span class="o">=</span> <span class="n">cpg_locations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">list_cpgs</span><span class="p">,:]</span>
            <span class="n">location_subset</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s1">&#39;makeGRangesFromDataFrame&#39;</span><span class="p">)(</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">py2ri</span><span class="p">(</span><span class="n">cpg_location_subset</span><span class="p">),</span><span class="n">start_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">end_field</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="n">starts_in_df_are_0based</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">lola_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lola</span><span class="o">.</span><span class="n">runLOLA</span><span class="p">(</span><span class="n">location_subset</span><span class="p">,</span><span class="n">all_cpg_regions</span><span class="p">,</span><span class="n">lolaDB</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;depletion&#39;</span> <span class="k">if</span> <span class="n">depletion</span> <span class="k">else</span> <span class="s1">&#39;enrichment&#39;</span><span class="p">))</span>
            <span class="n">output_dfs</span><span class="p">[</span><span class="s1">&#39;prediction_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">=</span><span class="n">pandas2ri</span><span class="o">.</span><span class="n">ri2py</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;as&#39;</span><span class="p">](</span><span class="n">order_by_max_rnk</span><span class="p">(</span><span class="n">lola_output</span><span class="p">),</span><span class="s1">&#39;data.frame&#39;</span><span class="p">))</span><span class="c1">#.iloc[:20,:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output_dfs</span><span class="p">[</span><span class="s1">&#39;prediction_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">output_dfs</span></div></div>
        <span class="c1">#https://academic.oup.com/bioinformatics/article/32/4/587/1743969</span>

<div class="viewcode-block" id="return_shap_values"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.return_shap_values">[docs]</a><span class="k">def</span> <span class="nf">return_shap_values</span><span class="p">(</span><span class="n">test_arr</span><span class="p">,</span> <span class="n">explainer</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">additional_opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return SHAP values, sampled a number of times, used in CpGExplainer class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    test_arr : type</span>
<span class="sd">        Testing MethylationArray.</span>
<span class="sd">    explainer : type</span>
<span class="sd">        SHAP explainer object.</span>
<span class="sd">    method : type</span>
<span class="sd">        Method of explaining.</span>
<span class="sd">    n_samples : type</span>
<span class="sd">        Number of samples to estimate SHAP scores.</span>
<span class="sd">    additional_opts : type</span>
<span class="sd">        Additional options to be passed into non-kernel/gradient methods.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array/list</span>
<span class="sd">        Shapley scores.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;kernel&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gradient&#39;</span><span class="p">:</span> <span class="c1"># ranked_outputs=ranked_outputs, add if feature_selection</span>
        <span class="n">svals</span><span class="o">=</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">test_arr</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_opts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gradient&#39;</span> <span class="ow">and</span> <span class="n">additional_opts</span><span class="p">[</span><span class="s1">&#39;ranked_outputs&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">test_arr</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">svals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">svals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([])</span> <span class="k">else</span> <span class="n">svals</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">test_arr</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_opts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">additional_opts</span><span class="p">[</span><span class="s1">&#39;ranked_outputs&#39;</span><span class="p">]</span> <span class="o">!=</span><span class="kc">None</span> <span class="k">else</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">test_arr</span><span class="p">))</span></div>

<div class="viewcode-block" id="to_tensor"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.to_tensor">[docs]</a><span class="k">def</span> <span class="nf">to_tensor</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn np.array into tensor.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Transformer</span><span class="p">()</span><span class="o">.</span><span class="n">generate</span><span class="p">()(</span><span class="n">arr</span><span class="p">)</span></div>

<div class="viewcode-block" id="return_predict_function"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.return_predict_function">[docs]</a><span class="k">def</span> <span class="nf">return_predict_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cuda</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to build the supplied prediction function, important for kernel explanations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : type</span>
<span class="sd">        Prediction function with predict method.</span>
<span class="sd">    cuda : type</span>
<span class="sd">        Run using cuda.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    function</span>
<span class="sd">        Predict function.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">loader</span><span class="p">):</span> <span class="c1"># model can be VAE_MLP, TybaltTitusVAE, or CVAE</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">loader</span><span class="p">:</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">Variable</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">forward_predict</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
        <span class="n">outputs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>
    <span class="k">return</span> <span class="n">predict</span></div>

<span class="c1"># https://github.com/slundberg/shap/blob/master/shap/common.py</span>
<span class="c1"># Provided model function fails when applied to the provided data set.</span>

<div class="viewcode-block" id="return_dataloader_construct"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.return_dataloader_construct">[docs]</a><span class="k">def</span> <span class="nf">return_dataloader_construct</span><span class="p">(</span><span class="n">n_workers</span><span class="p">,</span><span class="n">batch_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to build dataloader compatible with KernelExplainer for SHAP.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_workers : type</span>
<span class="sd">        Number CPU.</span>
<span class="sd">    batch_size : type</span>
<span class="sd">        Batch size to load data into pytorch.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DataLoader</span>
<span class="sd">        Pytorch dataloader.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">construct_data_loader</span><span class="p">(</span><span class="n">raw_beta_array</span><span class="p">):</span>
        <span class="n">raw_beta_dataset</span><span class="o">=</span><span class="n">RawBetaArrayDataSet</span><span class="p">(</span><span class="n">raw_beta_array</span><span class="p">,</span><span class="n">Transformer</span><span class="p">())</span>
        <span class="n">raw_beta_dataloader</span><span class="o">=</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">raw_beta_dataset</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">n_workers</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw_beta_dataloader</span>
    <span class="k">return</span> <span class="n">construct_data_loader</span></div>

<div class="viewcode-block" id="main_prediction_function"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.main_prediction_function">[docs]</a><span class="k">def</span> <span class="nf">main_prediction_function</span><span class="p">(</span><span class="n">n_workers</span><span class="p">,</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cuda</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Combine dataloader and prediction function into final prediction function that takes in tensor data, for Kernel Explanations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_workers : type</span>
<span class="sd">        Number of workers.</span>
<span class="sd">    batch_size : type</span>
<span class="sd">        Batch size for input data.</span>
<span class="sd">    model : type</span>
<span class="sd">        Model/predidction function.</span>
<span class="sd">    cuda : type</span>
<span class="sd">        Running on GPUs?</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    function</span>
<span class="sd">        Final prediction function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataloader_constructor</span><span class="o">=</span><span class="n">return_dataloader_construct</span><span class="p">(</span><span class="n">n_workers</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">predict_function</span><span class="o">=</span><span class="n">return_predict_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cuda</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">main_predict</span><span class="p">(</span><span class="n">raw_beta_array</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">predict_function</span><span class="p">(</span><span class="n">dataloader_constructor</span><span class="p">(</span><span class="n">raw_beta_array</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">main_predict</span></div>

<div class="viewcode-block" id="plot_lola_output_"><a class="viewcode-back" href="../../index.html#methylnet.interpretation_classes.plot_lola_output_">[docs]</a><span class="k">def</span> <span class="nf">plot_lola_output_</span><span class="p">(</span><span class="n">lola_csv</span><span class="p">,</span> <span class="n">plot_output_dir</span><span class="p">,</span> <span class="n">description_col</span><span class="p">,</span> <span class="n">cell_types</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots any LOLA output in the form of a forest plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lola_csv : type</span>
<span class="sd">        CSV containing lola results.</span>
<span class="sd">    plot_output_dir : type</span>
<span class="sd">        Plot output directory.</span>
<span class="sd">    description_col : type</span>
<span class="sd">        Column that will label the points on the plot.</span>
<span class="sd">    cell_types : type</span>
<span class="sd">        Column containing cell-types, colors plots and are rows to be compared.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot_output_dir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="c1"># from rpy2.robjects.packages import importr</span>
    <span class="c1"># import rpy2.robjects as robjects</span>
    <span class="c1"># from rpy2.robjects import pandas2ri</span>
    <span class="c1"># pandas2ri.activate()</span>
    <span class="c1"># ggplot=importr(&quot;ggplot2&quot;)</span>
    <span class="c1"># importr(&quot;ggpubr&quot;)</span>
    <span class="c1"># forcats=importr(&#39;forcats&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># create_bar_chart=robjects.r(&quot;&quot;&quot;function(df,fill.col=NULL){</span>
    <span class="c1">#                     ggboxplot(df, x = &quot;description&quot;, y = &quot;oddsRatio&quot;, fill = fill.col,#,</span>
    <span class="c1">#                       color = &quot;white&quot;,           # Set bar border colors to white</span>
    <span class="c1">#                       palette = &quot;jco&quot;,            # jco journal color palett. see ?ggpar</span>
    <span class="c1">#</span>
    <span class="c1">#                       orientation = &quot;horiz&quot;)}           # Sort the value in dscending order</span>
    <span class="c1">#                       #sort.by.groups = F, #TRUE,      # Sort inside each group</span>
    <span class="c1">#                       # sort.val = &quot;desc&quot;,</span>
    <span class="c1">#                       #)</span>
    <span class="c1">#                 #}&quot;&quot;&quot;)</span>

    <span class="k">def</span> <span class="nf">create_bar_chart</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;oddsRatio&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">cell_type</span><span class="p">,</span>
              <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">alpha</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;oddsRatio&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">cell_type</span><span class="p">,</span>
              <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=.</span><span class="mi">532</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;dark&quot;</span><span class="p">,</span>
              <span class="n">markers</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=.</span><span class="mi">75</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">labels</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cell Types&quot;</span><span class="p">,</span>
                  <span class="n">handletextpad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span><span class="n">ax</span>

    <span class="n">lola_results</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">lola_csv</span><span class="p">)</span><span class="c1">#[[&#39;collection&#39;,&#39;description&#39;,&#39;oddsRatio&#39;,&#39;cellType&#39;]]</span>

    <span class="c1"># filter cell types here</span>
    <span class="n">collections_df</span><span class="o">=</span><span class="n">lola_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">collections_df</span><span class="p">:</span>
        <span class="n">top_results_df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#top_results_df=pandas2ri.py2ri(top_results_df)#pandas2ri.py2ri(top_results_df)</span>
        <span class="c1">#robjects.r(&quot;print&quot;)(top_results_df)</span>
        <span class="c1">#top_results_df=robjects.r(&quot;function(df){data.frame(df,stringsAsFactors=FALSE)}&quot;)(robjects.r(&quot;function(df){lapply(df,as.character)}&quot;)(top_results_df)) # FIX</span>
        <span class="c1">#print(top_results_df)</span>
        <span class="sd">&quot;&quot;&quot;RESET FACTORS ^^^&quot;&quot;&quot;</span>
        <span class="c1">#diagnose_df=pandas2ri.ri2py(top_results_df)</span>
        <span class="n">top_results_df</span><span class="o">=</span><span class="n">top_results_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">f</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">create_bar_chart</span><span class="p">(</span><span class="n">top_results_df</span><span class="p">,</span><span class="n">description_col</span><span class="p">,</span><span class="s1">&#39;cellType&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">plot_output_dir</span><span class="p">,</span><span class="n">lola_csv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        <span class="c1">#ggplot.ggsave(join(plot_output_dir,lola_csv.split(&#39;/&#39;)[-1].replace(&#39;.csv&#39;,&#39;_{}.png&#39;.format(name))))</span>
    <span class="c1"># add shore island breakdown</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Joshua Levy

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>